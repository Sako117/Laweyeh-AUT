<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Election Status Console</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- ✅ Firebase v8 (REQUIRED — DO NOT CHANGE!) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <!-- Firebase Init -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCfCFY3f5SN97r9_SfQRacvIQRJLXz37wo",
      authDomain: "aut-lawe2eh-shateb.firebaseapp.com",
      projectId: "aut-lawe2eh-shateb",
      storageBucket: "aut-lawe2eh-shateb.firebasestorage.app",
      messagingSenderId: "1094948074968",
      appId: "1:1094948074968:web:480fc2e77d7c69cd256ead",
      measurementId: "G-JQX7X47T8N",
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>
</head>

<body class="bg-gray-50">
  <div id="root"></div>

  <script type="text/babel">

    const { useState, useEffect } = React;

    const ADMIN_PASSWORD = "AUT2025";

    function Login({ setMode }) {
      const [pw, setPw] = useState("");
      const [error, setError] = useState("");

      function submit(e) {
        e.preventDefault();
        if (pw === ADMIN_PASSWORD) setMode("admin");
        else setError("Invalid password.");
      }

      return (
        <div className="min-h-screen flex items-center justify-center p-6">
          <div className="bg-white p-6 rounded-xl shadow-xl w-full max-w-md">
            <h1 className="text-xl font-bold text-center mb-4">
              Election Console Login
            </h1>

            <button
              className="w-full py-3 mb-4 bg-blue-600 text-white font-bold rounded-lg"
              onClick={() => setMode("viewer")}
            >
              Continue as Viewer
            </button>

            <form onSubmit={submit}>
              <input
                type="password"
                placeholder="Admin password"
                className="w-full p-3 border rounded-lg mb-3"
                value={pw}
                onChange={(e) => setPw(e.target.value)}
              />

              {error && (
                <p className="text-red-600 text-sm mb-3">{error}</p>
              )}

              <button
                className="w-full py-3 bg-indigo-600 text-white font-bold rounded-lg"
              >
                Login as Admin
              </button>
            </form>
          </div>
        </div>
      );
    }

    function App() {
      const [mode, setMode] = useState("login");
      const [candidates, setCandidates] = useState(null);
      const [search, setSearch] = useState("");
      const [filter, setFilter] = useState("ALL");

      useEffect(() => {
        db.collection("candidates")
          .orderBy("id")
          .onSnapshot((snap) => {
            const arr = snap.docs.map((d) => d.data());
            setCandidates(arr);
          });
      }, []);

      function toggle(localId, current) {
        db.collection("candidates")
          .doc(localId)
          .update({ isElected: !current });
      }

      if (mode === "login") return <Login setMode={setMode} />;

      if (!candidates)
        return (
          <div className="text-center mt-40 text-xl text-gray-600">
            Loading election data…
          </div>
        );

      const filtered = candidates.filter((c) => {
        if (filter === "ELECTED" && !c.isElected) return false;
        if (filter === "NOT" && c.isElected) return false;
        if (search && !c.name.toLowerCase().includes(search.toLowerCase()))
          return false;
        return true;
      });

      return (
        <div className="p-6 max-w-4xl mx-auto">
          <header className="mb-6 bg-white shadow p-4 rounded-lg flex justify-between items-center">
            <div>
              <h1 className="text-3xl font-bold">Election Status Console</h1>
              <p className="text-sm text-gray-500">
                Mode:{" "}
                <span
                  className={
                    mode === "admin"
                      ? "text-indigo-600 font-bold"
                      : "text-blue-600 font-bold"
                  }
                >
                  {mode.toUpperCase()}
                </span>
              </p>
            </div>

            <button
              className="px-4 py-2 bg-red-600 text-white rounded-lg font-bold"
              onClick={() => setMode("login")}
            >
              Exit
            </button>
          </header>

          <div className="flex gap-4 mb-4">
            <input
              type="text"
              placeholder="Search by candidate name…"
              className="flex-1 p-3 border rounded-lg"
              value={search}
              onChange={(e) => setSearch(e.target.value)}
            />

            <select
              className="p-3 border rounded-lg"
              value={filter}
              onChange={(e) => setFilter(e.target.value)}
            >
              <option value="ALL">All Candidates</option>
              <option value="ELECTED">Elected</option>
              <option value="NOT">Remaining</option>
            </select>
          </div>

          <div className="space-y-3">
            {filtered.map((c) => (
              <div
                key={c.localId}
                className={
                  "p-4 rounded-lg border-2 flex justify-between items-center " +
                  (c.isElected
                    ? "bg-yellow-100 border-yellow-500"
                    : "bg-blue-100 border-blue-500")
                }
              >
                <span className="font-semibold">
                  {c.id}. {c.name}
                </span>

                <div className="flex items-center gap-3">
                  <span
                    className={
                      "px-3 py-1 rounded-full text-white text-xs font-bold " +
                      (c.isElected ? "bg-yellow-600" : "bg-blue-600")
                    }
                  >
                    {c.isElected ? "ELECTED" : "REMAINING"}
                  </span>

                  {mode === "admin" && (
                    <button
                      className={
                        "px-3 py-1 rounded-lg text-white font-bold " +
                        (c.isElected ? "bg-blue-600" : "bg-yellow-600")
                      }
                      onClick={() => toggle(c.localId, c.isElected)}
                    >
                      Toggle
                    </button>
                  )}
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById("root"));
  </script>
</body>
</html>
        };

        // Configuration access
        window.GlobalConfig = {
            appId: typeof __app_id !== 'undefined' ? __app_id : 'default-app-id',
            firebaseConfig: JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}'),
            initialAuthToken: typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null,
        };
    </script>
</head>

<body class="bg-gray-100 font-sans antialiased">
<div id="root"></div>

<script type="text/babel">

/* React shortcut hooks */
const useState = React.useState;
const useEffect = React.useEffect;
const {
    initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
    getFirestore, doc, updateDoc, onSnapshot, collection, query, setLogLevel, getDocs, setDoc
} = window.Firebase || {};
const { appId, firebaseConfig, initialAuthToken } = window.GlobalConfig || {};

/* Admin Password */
const ADMIN_PASSWORD = "AUT2025";

/* Firestore paths and constants */
const CANDIDATES_COLLECTION_NAME = "candidates";

function getCollectionPath(currentAppId) {
    // MANDATORY path for public, shared data: /artifacts/{appId}/public/data/{your_collection_name}
    return `artifacts/${currentAppId}/public/data/${CANDIDATES_COLLECTION_NAME}`;
}

// Mock Data for automatic setup
const INITIAL_CANDIDATES = [
    { id: 101, name: "Ali Sayegh", isElected: true },
    { id: 102, name: "Leen Hammoud", isElected: false },
    { id: 103, name: "George Khoury", isElected: false },
    { id: 104, name: "Nour Fares", isElected: false },
    { id: 105, name: "Rami Mhanna", isElected: true },
    { id: 106, name: "Maya Saad", isElected: false },
];

/**
 * Initializes the candidates collection with mock data if it is empty.
 */
async function seedCandidatesIfEmpty(firestoreDb, currentAppId) {
    const path = getCollectionPath(currentAppId);
    const candidatesCollectionRef = collection(firestoreDb, path);

    try {
        const snapshot = await getDocs(query(candidatesCollectionRef));
        
        if (snapshot.empty) {
            console.log("Collection is empty. Seeding initial data...");
            for (const candidate of INITIAL_CANDIDATES) {
                // Use a descriptive document ID
                const docId = `candidate-${candidate.id}`;
                const docRef = doc(candidatesCollectionRef, docId);
                // The document ID will be used as localId in the app
                await setDoc(docRef, candidate);
            }
            console.log("Initial data seeding complete.");
        } else {
            console.log(`Collection has ${snapshot.size} documents. Skipping seeding.`);
        }
    } catch (error) {
        console.error("Error during data seeding:", error);
    }
}


/* ---------------- LOGIN SCREEN ---------------- */
function Login({ setMode }) {
    const [password, setPassword] = useState("");
    const [error, setError] = useState("");

    function submit(e) {
        e.preventDefault();
        setError("");
        if (password === ADMIN_PASSWORD) setMode("admin");
        else setError("Invalid Admin Password.");
    }

    return (
        <div className="min-h-screen flex items-center justify-center p-4">
            <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md">
                <h1 className="text-3xl font-extrabold text-center mb-6 text-indigo-700">
                    Election Status Console
                </h1>

                <button
                    onClick={() => setMode("viewer")}
                    className="w-full py-3 mb-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl transition duration-200 shadow-md hover:shadow-lg"
                >
                    Continue as Viewer
                </button>

                <div className="relative my-6 flex items-center">
                    <div className="flex-grow border-t border-gray-300"></div>
                    <span className="flex-shrink mx-4 text-gray-500 font-medium">ADMIN ACCESS</span>
                    <div className="flex-grow border-t border-gray-300"></div>
                </div>

                <form onSubmit={submit}>
                    <input
                        type="password"
                        placeholder="Admin Password"
                        className="w-full p-3 border border-gray-300 focus:border-indigo-500 rounded-xl mb-4 transition"
                        value={password}
                        onChange={e => setPassword(e.target.value)}
                    />

                    {error && <p className="text-red-500 text-sm mb-4 font-medium bg-red-50 p-2 rounded-lg">{error}</p>}

                    <button
                        type="submit"
                        className="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl transition duration-200 shadow-md hover:shadow-lg"
                    >
                        Login as Admin
                    </button>
                </form>
            </div>
        </div>
    );
}

/* ------------------ APP ------------------ */
function App() {
    const [mode, setMode] = useState("login");
    const [candidates, setCandidates] = useState([]);
    const [search, setSearch] = useState("");
    const [filter, setFilter] = useState("ALL");
    const [isLoading, setIsLoading] = useState(true);

    /* Firebase State */
    const [db, setDb] = useState(null);
    const [authReady, setAuthReady] = useState(false);
    const [userId, setUserId] = useState(null);

    // 1. Firebase Initialization and Authentication
    useEffect(() => {
        if (!initializeApp || Object.keys(firebaseConfig).length === 0) {
            console.error("Firebase utilities or configuration missing.");
            return;
        }

        try {
            const firebaseApp = initializeApp(firebaseConfig);
            const firestoreDb = getFirestore(firebaseApp);
            const firebaseAuth = getAuth(firebaseApp);
            setLogLevel('Debug'); // Mandatory logging setup

            setDb(firestoreDb);

            // Authentication Listener
            const unsubscribeAuth = onAuthStateChanged(firebaseAuth, async (user) => {
                if (user) {
                    setUserId(user.uid);
                    // AUTH SUCCESS: Attempt to seed data if collection is empty
                    await seedCandidatesIfEmpty(firestoreDb, appId);
                } else {
                    // Sign in either with custom token or anonymously
                    if (initialAuthToken) {
                        try {
                            const userCred = await signInWithCustomToken(firebaseAuth, initialAuthToken);
                            setUserId(userCred.user.uid);
                            await seedCandidatesIfEmpty(firestoreDb, appId);
                        } catch (error) {
                            console.error("Error signing in with custom token:", error);
                            const userCred = await signInAnonymously(firebaseAuth);
                            setUserId(userCred.user.uid);
                            await seedCandidatesIfEmpty(firestoreDb, appId);
                        }
                    } else {
                        const userCred = await signInAnonymously(firebaseAuth);
                        setUserId(userCred.user.uid);
                        await seedCandidatesIfEmpty(firestoreDb, appId);
                    }
                }
                setAuthReady(true);
            });

            return () => {
                unsubscribeAuth();
            };

        } catch (e) {
            console.error("Error during Firebase initialization:", e);
            setAuthReady(true); // Stop loading if init fails
        }
    }, []);

    // 2. Firestore Realtime Listener
    useEffect(() => {
        // Guard clause: Do not run Firestore query until auth is ready and db is initialized
        if (!authReady || !db || !userId) {
            return;
        }

        const path = getCollectionPath(appId);
        const candidatesCollectionRef = collection(db, path);
        
        // Listen to candidates collection in real-time
        const q = query(candidatesCollectionRef); 

        const unsubscribeSnapshot = onSnapshot(q, (snapshot) => {
            let data = snapshot.docs.map(doc => ({
                localId: doc.id, // Use doc.id as the local identifier for updates
                ...doc.data()
            }));

            // Client-side sorting by the 'id' field (assuming 'id' is a number)
            data.sort((a, b) => (a.id || 0) - (b.id || 0));

            setCandidates(data);
            setIsLoading(false);
        }, (error) => {
            console.error("Error listening to Firestore snapshot:", error);
            // If there's an error (e.g., permission denied), stop loading and display error state
            setIsLoading(false); 
        });

        return () => unsubscribeSnapshot();
    }, [authReady, db, userId]); // Re-run when auth state changes or user ID changes

    /* ---------------- Update Firestore ---------------- */
    async function setStatus(localDocId, newValue) {
        if (!db || mode !== "admin") return;

        try {
            const docRef = doc(db, getCollectionPath(appId), localDocId);
            await updateDoc(docRef, { isElected: newValue });
            console.log(`Status updated for ${localDocId} to ${newValue}`);
        } catch (error) {
            console.error("Error updating candidate status:", error);
            // Optionally show a modal/error message instead of console.error
        }
    }

    /* -------------- Filtering Logic -------------- */
    const filtered = candidates.filter(c => {
        if (filter === "ELECTED" && !c.isElected) return false;
        if (filter === "NOT" && c.isElected) return false;
        if (search && !c.name.toLowerCase().includes(search.toLowerCase())) return false;
        return true;
    });

    if (mode === "login") return <Login setMode={setMode} />;

    return (
        <div className="console-container p-4 md:p-8">

            <header className="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center bg-white p-6 rounded-xl shadow-lg">
                <div>
                    <h1 className="text-4xl font-extrabold text-gray-800">Election Status Console</h1>
                    <p className="text-sm mt-2 text-gray-500 flex items-center gap-2">
                        <span>Mode:</span>
                        <span className={`px-2 py-1 rounded-full text-xs font-bold ${
                            mode === "admin" ? "bg-indigo-100 text-indigo-700" : "bg-blue-100 text-blue-700"
                        }`}>
                            {mode.toUpperCase()}
                        </span>
                        <span className="text-xs text-gray-400">| User ID: {userId || 'Authenticating...'}</span>
                    </p>
                </div>
                <button
                    onClick={() => setMode("login")}
                    className="mt-4 md:mt-0 px-5 py-2 bg-red-600 hover:bg-red-700 text-white rounded-xl font-semibold transition shadow-md hover:shadow-lg">
                    Exit
                </button>
            </header>

            {/* Search + Filters */}
            <div className="flex flex-col md:flex-row gap-4 mb-8">
                <input
                    value={search}
                    onChange={e => setSearch(e.target.value)}
                    placeholder="Search by candidate name..."
                    className="flex-1 p-3 border border-gray-300 focus:border-indigo-500 rounded-xl shadow-inner transition"
                />

                <select
                    className="p-3 border border-gray-300 rounded-xl shadow-inner bg-white"
                    value={filter}
                    onChange={e => setFilter(e.target.value)}
                >
                    <option value="ALL">Show All Candidates</option>
                    <option value="ELECTED">Elected Candidates</option>
                    <option value="NOT">Remaining Candidates</option>
                </select>
            </div>
            
            {/* Loading Indicator */}
            {isLoading && (
                <div className="text-center p-10 text-xl font-medium text-gray-500">
                    Loading election data...
                </div>
            )}

            {/* Candidate List */}
            {!isLoading && filtered.length === 0 && (
                <div className="text-center p-10 text-xl font-medium text-gray-500 bg-white rounded-xl shadow">
                    No candidates match the current filter/search.
                </div>
            )}

            {!isLoading && (
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    {filtered.map(c => (
                        <div
                            key={c.localId}
                            className={`candidate-card-base p-5 rounded-2xl border-4 shadow-lg flex flex-col sm:flex-row justify-between items-center transition duration-300 ${
                                c.isElected 
                                ? "bg-yellow-50 border-yellow-500 shadow-yellow-200/50" 
                                : "bg-blue-50 border-blue-500 shadow-blue-200/50"
                            }`}
                        >
                            <div className="flex items-center gap-3 mb-3 sm:mb-0">
                                <span className={`w-8 h-8 flex items-center justify-center text-lg font-bold rounded-full text-white ${
                                    c.isElected ? "bg-yellow-600" : "bg-blue-600"
                                }`}>{c.id}</span>
                                <span className="text-xl font-bold text-gray-700">{c.name}</span>
                            </div>

                            <div className="flex items-center gap-3">
                                <span className={`px-4 py-1 rounded-full text-sm font-extrabold shadow-inner ${
                                    c.isElected ? "bg-yellow-600 text-white" : "bg-blue-600 text-white"
                                }`}>
                                    {c.isElected ? "ELECTED" : "REMAINING"}
                                </span>

                                {/* Admin toggle */}
                                {mode === "admin" && (
                                    <button
                                        onClick={() => setStatus(c.localId, !c.isElected)}
                                        className={`px-4 py-2 rounded-xl text-white font-bold transition duration-200 shadow-md hover:shadow-lg transform hover:scale-105 ${
                                            c.isElected ? "bg-red-600 hover:bg-red-700" : "bg-green-600 hover:bg-green-700"
                                        }`}
                                        title={c.isElected ? "Mark as Remaining" : "Mark as Elected"}
                                    >
                                        {c.isElected ? "Unmark" : "Mark Elected"}
                                    </button>
                                )}
                            </div>
                        </div>
                    ))}
                </div>
            )}

        </div>
    );
}

/* React Render */
const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<App />);
</script>
</body>
</html>

